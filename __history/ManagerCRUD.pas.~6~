unit ManagerCRUD;

interface

uses
  System.SysUtils, FireDAC.Comp.Client, Data.DB, Vcl.Dialogs;

type
  TManagerCRUD = class
  private
    FQuery: TFDQuery;
    FTableName: String;
    FCustomSQL: String;
  public
    constructor Create(AQuery: TFDQuery; ATableName: String;
      ACustomSQL: String = '');

    procedure LoadAll;
    procedure Add(AFields, AValues: array of String);
    procedure Delete(AID: Integer);
    procedure Update(AFields, AValues: array of String; AID: Integer);
    procedure Search(AField, AKeyword: String);
    procedure SaveChanges;
    procedure RefreshGrid;
  end;

implementation

constructor TManagerCRUD.Create(AQuery: TFDQuery; ATableName: String;
  ACustomSQL: String);
begin
  FQuery := AQuery;
  FTableName := ATableName;
  FCustomSQL := ACustomSQL;
end;

procedure TManagerCRUD.LoadAll;
begin
  FQuery.SQL.Text := 'SELECT * FROM ' + FTableName;
  FQuery.Open;
end;

procedure TManagerCRUD.Add(AFields, AValues: array of String);
var
  FieldsList, ParamsList: String;
  I: Integer;
begin
  FieldsList := '';
  ParamsList := '';

  for I := Low(AFields) to High(AFields) do
  begin
    if I > Low(AFields) then
    begin
      FieldsList := FieldsList + ', ';
      ParamsList := ParamsList + ', ';
    end;
    FieldsList := FieldsList + AFields[I];
    ParamsList := ParamsList + ':' + AFields[I];
  end;

  FQuery.SQL.Text := Format('INSERT INTO %s (%s) VALUES (%s)',
    [FTableName, FieldsList, ParamsList]);


  // ShowMessage('Generated SQL: ' + FQuery.SQL.Text);

  for I := Low(AValues) to High(AValues) do
    FQuery.ParamByName(AFields[I]).AsString := AValues[I];

  FQuery.ExecSQL;
  RefreshGrid;
end;

procedure TManagerCRUD.Delete(AID: Integer);
begin
  FQuery.SQL.Text := Format('DELETE FROM %s WHERE id = :id', [FTableName]);
  FQuery.ParamByName('id').AsInteger := AID;
  FQuery.ExecSQL;
  RefreshGrid;
end;

procedure TManagerCRUD.Update(AFields, AValues: array of String; AID: Integer);
var
  SetClause: String;
  I: Integer;
begin
  SetClause := '';

  for I := Low(AFields) to High(AFields) do
  begin
    if I > Low(AFields) then
      SetClause := SetClause + ', ';
    SetClause := SetClause + Format('%s = :%s', [AFields[I], AFields[I]]);
  end;

  FQuery.SQL.Text := Format('UPDATE %s SET %s WHERE id = :id',
    [FTableName, SetClause]);
  FQuery.ParamByName('id').AsInteger := AID;

  for I := Low(AFields) to High(AFields) do
    FQuery.ParamByName(AFields[I]).AsString := AValues[I];

  FQuery.ExecSQL;
  RefreshGrid;
end;

//Добавить ф-цию откл фильтра?
procedure TManagerCRUD.Search(AField, AKeyword: String);
begin
  // Приводим как поле, так и ключевое слово к нижнему регистру для корректного сравнения
  FQuery.DisableControls; // Отключаем обновление данных во время фильтрации
  try
    FQuery.Filtered := False; // Снимаем текущий фильтр

    // Используем фильтрацию для поля, при этом сравниваем все в нижнем регистре
    FQuery.Filter := Format('Lower(%s) LIKE :keyword', [AField]);
    FQuery.ParamByName('keyword').AsString := '%' + LowerCase(AKeyword) + '%';

    FQuery.Filtered := True; // Включаем фильтрацию
  finally
    FQuery.EnableControls; // Включаем обновление данных обратно
  end;
end;


procedure TManagerCRUD.SaveChanges;
begin
  FQuery.ApplyUpdates(0);
  RefreshGrid;
end;

procedure TManagerCRUD.RefreshGrid;
begin
  // Если передан кастомный SQL-запрос, используем его
  if FCustomSQL <> '' then
  begin
    FQuery.SQL.Text := FCustomSQL;
    FQuery.Open;
  end
  else
  begin
    FQuery.Refresh;
  end;
end;

end.
